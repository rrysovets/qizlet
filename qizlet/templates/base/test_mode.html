<!DOCTYPE html>
<html lang="ru">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Режим "Карточки" - Тестирование</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static "base/css/test.css" %}" type="text/css">
</head>
<body>
  <h1>Режим "Карточки" - Тестирование</h1>
  
  <!-- Панель выбора вариантов тестирования -->
  <div id="mode-selection">
    <h2>Выберите варианты тестов</h2>
    <label><input type="checkbox" name="variants" value="1"> Вариант 1: Выбор ответа</label>
    <label><input type="checkbox" name="variants" value="2"> Вариант 2: Ввод ответа</label>
    <label><input type="checkbox" name="variants" value="3"> Вариант 3: Соединение пар</label>
    <label><input type="checkbox" name="variants" value="4"> Вариант 4: Правда/Ложь</label>
    <br>
    <button id="start-test" class="btn btn-primary">Начать тест</button>
  </div>
  
  <!-- Тестовый контейнер -->
  <div id="test-container" style="display: none;">
    <div id="progress"></div>
    <!-- Общий контейнер для карточки (используется для вариантов 1,2,4) -->
    <div class="flashcard-container" id="card-container">
      <div id="flashcard" class="flashcard">
        <div class="flashcard-side flashcard-front" id="card-front"></div>
        <div class="flashcard-side flashcard-back" id="card-back"></div>
      </div>
    </div>
    
    <!-- Вариант 1: Multiple Choice -->
    <div id="variant-1" class="test-variant" style="display: none;">
      <div class="options" id="mc-options"></div>
    </div>
    
    <!-- Вариант 2: Free text (объединённый режим) -->
    <div id="variant-2" class="test-variant" style="display: none;">
      <div class="free-text-test">
        <input type="text" id="ft-input" placeholder="Введите ответ">
        <button id="ft-submit" class="btn btn-primary">Проверить</button>
      </div>
    </div>
    
    <!-- Вариант 3: Matching (обёрнут в форму) -->
    <div id="variant-3" class="test-variant" style="display: none;">
      <form id="matching-form">
        <div class="matching-test">
          <div class="column" id="matching-words">
            <h4>Слово</h4>
            <ul id="words-list"></ul>
          </div>
          <div class="column" id="matching-translations">
            <h4>Перевод</h4>
            <ul id="translations-list"></ul>
          </div>
        </div>
        <button type="submit" id="matching-check" class="btn btn-primary">Проверить пары</button>
      </form>
    </div>
    
    <!-- Вариант 4: True/False -->
    <div id="variant-4" class="test-variant" style="display: none;">
      <!-- Используем общий контейнер flashcard для отображения вопроса -->
      <div class="true-false-test">
        {% comment %} <div id="tf-display" class="flashcard-container" style="margin: 0 auto 20px; width:300px; height:200px;">
          <div id="flashcard-tf" class="flashcard">
            <div class="flashcard-side flashcard-front" id="tf-front"></div>
            <div class="flashcard-side flashcard-back" id="tf-back"></div>
          </div>
        </div> {% endcomment %}
        <div class="options">
          <button class="btn btn-success tf-option" data-answer="true">Правда</button>
          <button class="btn btn-danger tf-option" data-answer="false">Ложь</button>
        </div>
      </div>
    </div>
    
    <!-- Сообщение результата -->
    <div id="result-message"></div>
    
    <!-- Кнопка "Следующая карточка" -->
    <button id="next-btn" class="btn btn-nav btn-primary" style="display: none;">Следующая карточка</button>
  </div>
  
  <!-- Статистика -->
  <div id="stats" style="display: none;"></div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Получаем данные из контекста (словарь words)
    const words = {{ words|safe }};
    // Преобразуем словарь в массив карточек [{front, back}, ...]
    let cards = [];
    for (const [front, back] of Object.entries(words)) {
      cards.push({ front, back });
    }
    // Перемешиваем карточки
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    shuffle(cards);
    
    let currentIndex = 0;
    let correctCount = 0;
    const totalCount = cards.length;
    let chosenVariants = [];
    // Флаг для объединённого режима 2
    let isInverted = false;
    
    // Обновление прогресса
    function updateProgress() {
      $('#progress').text(`Вопрос ${currentIndex + 1} из ${totalCount}`);
    }
    
    // Обработка нажатия на кнопку "Начать тест"
    $('#start-test').click(function() {
      chosenVariants = [];
      $('input[name="variants"]:checked').each(function() {
        chosenVariants.push($(this).val());
      });
      if (chosenVariants.length === 0) {
        alert("Выберите хотя бы один вариант теста!");
        return;
      }
      $('#mode-selection').hide();
      $('#test-container').show();
      // Если выбран режим 3, скрываем общий flashcard, иначе показываем его
      if(chosenVariants.includes('3')) {
        $('#card-container').hide();
      } else {
        $('#card-container').show();
      }
      currentIndex = 0;
      correctCount = 0;
      updateProgress();
      loadCurrentCard();
    });
    
    // Функция случайного выбора варианта из выбранных
    function getRandomVariant() {
      return chosenVariants[Math.floor(Math.random() * chosenVariants.length)];
    }
    
    // Функция загрузки текущей карточки
    function loadCurrentCard() {
      $('#result-message').empty();
      $('#next-btn').hide();
      // Если вариант не Matching, скрываем общий flashcard
      if (!chosenVariants.includes('3')) {
        $('#card-back').hide();
      }
      if (currentIndex >= totalCount) {
        showStats();
        return;
      }
      updateProgress();
      const card = cards[currentIndex];
      
      // Определяем вариант
      let variant = getRandomVariant();
      // Если выбран режим 2, используем объединённый режим
      if (variant === '2') {
        isInverted = Math.random() < 0.5;
        variant = '2';
      }
      // Скрываем все варианты интерфейса
      $('.test-variant').hide();
      
      if (variant === '1') {
        // Вариант 1: Multiple Choice
        $('#card-container').show();
        generateMCOptions(card);
        $('#variant-1').show();
      } else if (variant === '2') {
        // Вариант 2: Free text (объединённый)
        $('#card-container').show();
        if (isInverted) {
          $('#ft-input').attr('placeholder', 'Введите слово');
          $('#card-front').text(card.back);
          $('#card-back').text(card.front);
        } else {
          $('#ft-input').attr('placeholder', 'Введите перевод');
          $('#card-front').text(card.front);
          $('#card-back').text(card.back);
        }
        $('#variant-2').show();
        $('#ft-input').val('');
      } else if (variant === '3') {
        // Вариант 3: Matching
        generateMatchingTest();
        $('#variant-3').show();
      } else if (variant === '4') {
        // Вариант 4: True/False - используем общий flashcard
        $('#card-container').show();
        generateTFQuestion(card);
        $('#variant-4').show();
      }
    }
    
    // Функция показа статистики
    function showStats() {
      let percent = Math.round((correctCount / totalCount) * 100);
      $('#test-container').hide();
      $('#stats').show().html(`Тест завершён. Правильных ответов: ${correctCount} из ${totalCount} (<span style="color:green;">${percent}%</span>)`);
    }
    
    // Генерация вариантов для Multiple Choice (Вариант 1)
    function generateMCOptions(card) {
      $('#mc-options').empty();
      let options = [card.back];
      while (options.length < 4 && options.length < totalCount) {
        let randomOption = cards[Math.floor(Math.random() * totalCount)].back;
        if (!options.includes(randomOption)) {
          options.push(randomOption);
        }
      }
      shuffle(options);
      options.forEach(option => {
        $('#mc-options').append(`<button type="button" class="btn btn-outline-secondary mc-option" data-answer="${option}">${option}</button>`);
      });
    }
    
    // Генерация для Matching (Вариант 3)
    function generateMatchingTest() {
      // Выбираем 4 уникальные карточки
      let selected = [];
      if (totalCount <= 4) {
        selected = cards.slice();
      } else {
        while (selected.length < 4) {
          let candidate = cards[Math.floor(Math.random() * totalCount)];
          if (!selected.some(item => item.front === candidate.front)) {
            selected.push(candidate);
          }
        }
      }
      // Очистка списков
      $('#words-list').empty();
      $('#translations-list').empty();
      // Собираем переводы
      let translations = selected.map(item => item.back);
      shuffle(translations);
      // Заполняем левую колонку словами
      selected.forEach(item => {
        $('#words-list').append(`<li style="font-size:24px; margin-bottom:10px;">${item.front}</li>`);
      });
      // Для каждой карточки создаем select со всеми вариантами переводов
      selected.forEach(item => {
        let optionsHtml = `<select class="matching-select form-control" data-correct="${item.back}" style="margin-bottom:10px; font-size:16px;">`;
        optionsHtml += `<option value="">Выберите перевод</option>`;
        translations.forEach(trans => {
          optionsHtml += `<option value="${trans}">${trans}</option>`;
        });
        optionsHtml += `</select>`;
        $('#translations-list').append(`<li>${optionsHtml}</li>`);
      });
    }
    
    // Генерация для True/False (Вариант 4)
    function generateTFQuestion(card) {
      // Используем общий flashcard: выводим вопрос на лицевой стороне с увеличенным шрифтом
      let isCorrect = Math.random() < 0.5;
      if (!isCorrect) {
        let wrong = cards[Math.floor(Math.random() * totalCount)].back;
        while(wrong === card.back && totalCount > 1) {
          wrong = cards[Math.floor(Math.random() * totalCount)].back;
        }
        $('#card-front').text(`${card.front} → ${wrong}`);
        $('#card-back').text(`Правильный ответ: ${card.back}`);
        $('#flashcard').data('correct', "false");
      } else {
        $('#card-front').text(`${card.front} → ${card.back}`);
        $('#card-back').text(``);
        $('#flashcard').data('correct', "true");
      }
      $('#card-front').css('font-size', '28px');
      $('#card-back').css('font-size', '28px');
    }
    
    // Обработка клика для Multiple Choice (Вариант 1)
    $(document).on('click', '.mc-option', function() {
      $('#card-back').fadeIn();
      const chosen = $(this).data('answer');
      const correct = cards[currentIndex].back;
      let message = '';
      if (chosen === correct) {
        message = `<span style="color:green;">Правильно!</span>`;
        correctCount++;
      } else {
        message = `<span style="color:red;">Неверно! Правильный ответ: ${correct}</span>`;
      }
      $('#result-message').html(message);
      $('.mc-option').prop('disabled', true);
      $('#next-btn').show();
    });
    
    // Обработка для Free Text (Вариант 2)
    $(document).on('click', '#ft-submit', function() {
      $('#card-back').fadeIn();
      const answer = $('#ft-input').val().trim();
      let correct, expected;
      if (isInverted) {
        correct = cards[currentIndex].front;
        expected = "исходное слово";
      } else {
        correct = cards[currentIndex].back;
        expected = "перевод";
      }
      let message = '';
      if (answer.toLowerCase() === correct.toLowerCase()){
        message = `<span style="color:green;">Правильно!</span>`;
        correctCount++;
      } else {
        message = `<span style="color:red;">Неверно! Правильный ${expected}: ${correct}</span>`;
      }
      $('#result-message').html(message);
      $('#next-btn').show();
    });
    
    // Обработка для Matching (Вариант 3)
    $('#matching-form').off('submit').on('submit', function(e) {
      e.preventDefault();
      let matchCorrect = 0;
      $('.matching-select').each(function() {
        const selected = $(this).val();
        const correct = $(this).data('correct');
        if(selected === correct) {
          matchCorrect++;
        }
      });
      let message = '';
      if (matchCorrect === $('.matching-select').length) {
        message = `<span style="color:green;">Все пары совпадают!</span>`;
        correctCount++;
      } else {
        message = `<span style="color:red;">Неверно! Проверьте свои ответы.</span>`;
      }
      $('#result-message').html(message);
      $('#next-btn').show();
    });
    
    // Обработка для True/False (Вариант 4)
    $(document).on('click', '.tf-option', function() {
      $('#card-back').fadeIn();
      const userAnswer = $(this).data('answer'); // "true" or "false"
      const correct = $('#flashcard').data('correct');
      let message = '';
      if(userAnswer.toString() === correct.toString()){
        message = `<span style="color:green;">Правильно!</span>`;
        correctCount++;
      } else {
        message = `<span style="color:red;">Неверно!</span>`;
      }
      $('#result-message').html(message);
      $('#next-btn').show();
    });
    
    // Кнопка "Следующая карточка"
    $('#next-btn').click(function() {
      currentIndex++;
      $('#card-back').hide();
      $('#result-message').empty();
      // Для Matching очищаем списки
      $('#words-list, #translations-list').empty();
      loadCurrentCard();
      $(this).hide();
    });
    
    // Обновление прогресса
    function updateProgress() {
      $('#progress').text(`Вопрос ${currentIndex + 1} из ${totalCount}`);
    }
    
    // Функция показа статистики
    function showStats() {
      let percent = Math.round((correctCount / totalCount) * 100);
      $('#test-container').hide();
      $('#stats').show().html(`Тест завершён. Правильных ответов: ${correctCount} из ${totalCount} (<span style="color:green;">${percent}%</span>)`);
    }
    
    // Функция загрузки карточки для режимов 1,2,4 (Matching обрабатывается отдельно)
    function loadCurrentCard() {
      $('#result-message').empty();
      $('#next-btn').hide();
      if (currentIndex >= totalCount) {
        showStats();
        return;
      }
      updateProgress();
      const card = cards[currentIndex];
      
      // Если выбран режим 3 Matching, скрываем общий flashcard
      let variant = getRandomVariant();
      if (variant === '3') {
        $('#card-container').hide();
        generateMatchingTest();
        $('.test-variant').hide();
        $('#variant-3').show();
        return;
      } else {
        $('#card-container').show();
      }
      
      // Для вариантов 1,2,4 используем общий flashcard
      if (variant === '1') {
        generateMCOptions(card);
        $('.test-variant').hide();
        $('#variant-1').show();
      } else if (variant === '2') {
        isInverted = Math.random() < 0.5;
        $('.test-variant').hide();
        if (isInverted) {
          $('#ft-input').attr('placeholder', 'Введите слово');
          $('#card-front').text(card.back);
          $('#card-back').text(card.front);
        } else {
          $('#ft-input').attr('placeholder', 'Введите перевод');
          $('#card-front').text(card.front);
          $('#card-back').text(card.back);
        }
        $('#variant-2').show();
        $('#ft-input').val('');
      } else if (variant === '4') {
        
        $('.test-variant').hide();
        generateTFQuestion(card);
        $('#variant-4').show();
      }
    }
    
    // Функция случайного выбора варианта из выбранных
    function getRandomVariant() {
      return chosenVariants[Math.floor(Math.random() * chosenVariants.length)];
    }
    
    // Событие кнопки "Начать тест"
    $('#start-test').click(function() {
      chosenVariants = [];
      $('input[name="variants"]:checked').each(function() {
        chosenVariants.push($(this).val());
      });
      if(chosenVariants.length === 0) {
        alert("Выберите хотя бы один вариант теста!");
        return;
      }
      $('#mode-selection').hide();
      $('#test-container').show();
      // Если режим Matching выбран, скрываем общий flashcard
      if(chosenVariants.includes('3')) {
        $('#card-container').hide();
      } else {
        $('#card-container').show();
      }
      currentIndex = 0;
      correctCount = 0;
      updateProgress();
      loadCurrentCard();
    });
  </script>
</body>
</html>
